<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Provisionamento de Tarefas - Kanban</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css");

    .GridCalendario {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 12px;
      padding-bottom: 8px;
    } 
    .day {
      border: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      position: relative;
      width: 320px;
      min-height: 500px;
      background: #fafafa;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
      min-width: 260px;
      flex: 0 0 auto;
    }
    .day-header {
      background: #444;
      color: #fff;
      padding: 0.5rem;
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
    }
    .day-body {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
    }
    .label-total {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #666;
      color: #fff;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
    }
    .card {
      padding: 0.5rem;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: all 0.2s ease;
    }
    .card:hover {
      background: #f9f9f9;
      border-color: #999;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }

    .badge-texto,
    .badge-layout,
    .badge-html {
      font-size: 0.9rem;
      font-weight: 600;
      padding: 4px 25px;
      border-radius: 6px;
      display: inline-block;
      width: fit-content;
      margin: 0 auto;
      text-align: center;
    }

    .badge-texto {
      background: #0084ff;
      color: #fff;
    }

    .badge-layout {
      background: #ffae00;
      color: #000;
    }

    .badge-html {
      background: #00d33f;
      color: #000;
    }

    .card p {
      margin: 0;
      line-height: 1.2em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card .descricao {
      font-size: 0.75rem;
      color: #555;
      max-height: 3em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
    }

    .filtros-container {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .form-control, .form-select {
      min-width: 160px;
    }
  </style>
</head>
<body class="p-4">
  <div class="container-fluid">
    <div class="row mb-3">
      <div class="col-md-8">
        <h3>üìÖ Kanban de Tarefas</h3>
      </div>
      <div class="col-md-4 text-end">
        <div class="d-flex gap-2">
          <select id="projeto" class="form-select">
            <option value="">Selecione o Projeto</option>
          </select>
          <select id="ano" class="form-select">
            <option value="">Ano</option>
          </select>
          <select id="mes" class="form-select">
            <option value="">M√™s</option>
          </select>
          <button id="gerarBtn" class="btn btn-primary">Buscar</button>
        </div>
      </div>
    </div>

    <div class="filtros-container">
      <select id="filtroStatus" class="form-select">
        <option value="">üìå Todos os Status</option>
        <option value="pendente">‚è≥ Pendentes</option>
        <option value="conclu√≠do">‚úÖ Conclu√≠das</option>
      </select>
      <input type="text" id="buscaTitulo" class="form-control" placeholder="üîç Buscar por t√≠tulo da tarefa">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="ocultarVazios">
        <label class="form-check-label" for="ocultarVazios">
          Ocultar dias sem tarefas
        </label>
      </div>
    </div>

    <div id="totais" class="mb-3 text-end text-muted small"></div>
    <div id="calendario" class="GridCalendario"></div>
    <div id="tabela" style="display: none;"></div>
<script>
const usuario = "Gui-Ferreir4";
const repo = "provisionamento";

const gerarBtn = document.getElementById("gerarBtn");
const anoInput = document.getElementById("ano");
const mesSelect = document.getElementById("mes");
const projetoSelect = document.getElementById("projeto");
const filtroStatus = document.getElementById("filtroStatus");
const buscaTitulo = document.getElementById("buscaTitulo");
const ocultarVazios = document.getElementById("ocultarVazios");

const calendario = document.getElementById("calendario");
const tabelaDiv = document.getElementById("tabela");
const totaisDiv = document.getElementById("totais");

let tarefas = [];

const diasSemana = ['DOM','SEG','TER','QUA','QUI','SEX','SAB'];

async function carregarProjetos() {
  const url = `https://api.github.com/repos/${usuario}/${repo}/contents/data`;
  try {
    const resposta = await fetch(url);
    const lista = await resposta.json();
    const projetos = lista.filter(item => item.type === "dir").map(item => item.name);
    projetos.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      projetoSelect.appendChild(opt);
    });
  } catch (erro) {
    console.error("Erro ao listar projetos:", erro);
  }
}

async function atualizarPeriodos(projeto) {
  const url = `https://api.github.com/repos/${usuario}/${repo}/contents/data/${projeto}`;
  try {
    const resposta = await fetch(url);
    const arquivos = await resposta.json();

    const periodos = arquivos
      .filter(arq => arq.name.startsWith("tarefas_") && arq.name.endsWith(".json"))
      .map(arq => {
        const partes = arq.name.match(/tarefas_(\d{4})_(\d{2})\.json/);
        return partes ? { ano: partes[1], mes: partes[2] } : null;
      })
      .filter(Boolean);

    const anosUnicos = [...new Set(periodos.map(p => p.ano))];
    anoInput.innerHTML = '<option value="">Ano</option>';
    anosUnicos.sort().forEach(ano => {
      const opt = document.createElement("option");
      opt.value = ano;
      opt.textContent = ano;
      anoInput.appendChild(opt);
    });

    mesSelect.innerHTML = '<option value="">M√™s</option>';
    const mesesUnicos = [...new Set(periodos.map(p => p.mes))];
    const nomesMeses = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

    mesesUnicos.sort().forEach(mesNum => {
      const opt = document.createElement("option");
      opt.value = parseInt(mesNum, 10);
      opt.textContent = nomesMeses[parseInt(mesNum, 10) - 1];
      mesSelect.appendChild(opt);
    });

  } catch (erro) {
    console.error("Erro ao buscar per√≠odos:", erro);
    anoInput.innerHTML = '<option value="">Ano</option>';
    mesSelect.innerHTML = '<option value="">M√™s</option>';
  }
}

async function carregarDadosDoGitHub(projeto, ano, mes) {
  const caminho = `data/${projeto}/tarefas_${ano}_${String(mes).padStart(2, '0')}.json`;
  try {
    const resposta = await fetch(`https://raw.githubusercontent.com/${usuario}/${repo}/main/${caminho}`);
    if (!resposta.ok) throw new Error("N√£o foi poss√≠vel carregar os dados do GitHub");
    const dados = await resposta.json();
    return dados;
  } catch (erro) {
    console.error("Erro ao carregar JSON do GitHub:", erro);
    return [];
  }
}

function extrairDiaDataLocal(dataStr) {
  const [ano, mes, dia] = dataStr.split("-").map(Number);
  return new Date(ano, mes - 1, dia).getDate();
}

function transformarTarefas(dados) {
  return dados.map(d => ({
    id: d["ID Tarefa"] + "_" + d["Subtarefa"],
    titulo: d["T√≠tulo Tarefa"],
    chamado: d["Chamado"] || "",
    status: (d["Status"] || "Pendente").toLowerCase(),
    dia: extrairDiaDataLocal(d["Data Entrega"]),
    tipo: (d["Tipo Subtarefa"] || "").toLowerCase(),
    ano: new Date(d["Data Entrega"]).getFullYear(),
    mes: new Date(d["Data Entrega"]).getMonth() + 1
  }));
}
function gerarCalendario() {
  const ano = parseInt(anoInput.value);
  const mes = parseInt(mesSelect.value);
  const statusFiltro = filtroStatus.value.toLowerCase();
  const busca = buscaTitulo.value.trim().toLowerCase();
  const ocultar = ocultarVazios.checked;

  const tarefasDoPeriodo = tarefas.filter(t => {
    const correspondeStatus = !statusFiltro || t.status === statusFiltro;
    const correspondeBusca = !busca || t.titulo.toLowerCase().includes(busca);
    return t.ano === ano && t.mes === mes && correspondeStatus && correspondeBusca;
  });

  const diasNoMes = new Date(ano, mes, 0).getDate();

  const diasUteis = Array.from({ length: diasNoMes }, (_, i) => i + 1).filter(d => {
    const dow = new Date(ano, mes - 1, d).getDay();
    return dow >= 1 && dow <= 5;
  });

  calendario.innerHTML = "";
  const fragment = document.createDocumentFragment();

  diasUteis.forEach(dia => {
    const tarefasDoDia = tarefasDoPeriodo.filter(t => t.dia === dia);

    if (ocultar && tarefasDoDia.length === 0) return;

    const cell = document.createElement("div");
    cell.className = "day";

    const date = new Date(ano, mes - 1, dia);
    const diaSemana = diasSemana[date.getDay()];

    cell.innerHTML = `
      <div class="day-header">${dia} (${diaSemana})</div>
      <div class="day-body"></div>
    `;

    const body = cell.querySelector(".day-body");

    tarefasDoDia
      .sort((a, b) => {
        const statusOrder = ["pendente", "conclu√≠do"];
        const tipoOrder = ["texto", "layout", "html"];
        return statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status) ||
               tipoOrder.indexOf(a.tipo) - tipoOrder.indexOf(b.tipo);
      })
      .forEach(tarefa => {
        const card = document.createElement("div");
        card.className = "card";

        // Estilo visual por status
        if (tarefa.status === "conclu√≠do") {
          card.style.border = "2px solid #28a745";
          card.style.backgroundColor = "#eafbe7";
          card.innerHTML += `<div style="font-size: 1rem; color: #28a745;">‚úÖ Conclu√≠do</div>`;
        } else if (tarefa.status === "pendente") {
          card.style.border = "2px solid #ffeeba";
          card.style.backgroundColor = "#fff3cd";
          card.innerHTML += `<div style="font-size: 1rem; color: #856404;">‚è≥ Pendente</div>`;
        }

        // Tooltip com detalhes completos
        card.title = `ID: ${tarefa.id.split("_")[0]}\nT√≠tulo: ${tarefa.titulo}\nStatus: ${tarefa.status}\nChamado: ${tarefa.chamado || '‚Äî'}`;

        const badge = document.createElement("div");
        badge.className = `badge badge-${tarefa.tipo}`;
        badge.textContent = tarefa.tipo;
        card.appendChild(badge);

        const id = document.createElement("p");
        id.innerHTML = `<strong>üÜî ID:</strong> ${tarefa.id.split('_')[0]}`;
        card.appendChild(id);

        const titulo = document.createElement("p");
        titulo.innerHTML = `<strong>üìù T√≠tulo:</strong> ${tarefa.titulo}`;
        card.appendChild(titulo);

        if (tarefa.chamado) {
          const chamado = document.createElement("p");
          chamado.className = "descricao";
          chamado.innerHTML = `<strong>üéüÔ∏è Chamado:</strong> ${tarefa.chamado}`;
          chamado.title = tarefa.chamado;
          card.appendChild(chamado);
        }

        body.appendChild(card);
      });

    if (tarefasDoDia.length > 0) {
      const totalBadge = document.createElement("span");
      totalBadge.className = "label-total";
      totalBadge.textContent = tarefasDoDia.length;
      cell.appendChild(totalBadge);
    }

    fragment.appendChild(cell);
  });

  calendario.appendChild(fragment);
}
function gerarTabela() {
  const ano = parseInt(anoInput.value);
  const mes = parseInt(mesSelect.value);
  const statusFiltro = filtroStatus.value.toLowerCase();
  const busca = buscaTitulo.value.trim().toLowerCase();

  const tarefasDoPeriodo = tarefas.filter(t => {
    const correspondeStatus = !statusFiltro || t.status === statusFiltro;
    const correspondeBusca = !busca || t.titulo.toLowerCase().includes(busca);
    return t.ano === ano && t.mes === mes && correspondeStatus && correspondeBusca;
  }).sort((a, b) => {
    return a.dia - b.dia ||
      ["texto", "layout", "html"].indexOf(a.tipo) - ["texto", "layout", "html"].indexOf(b.tipo);
  });

  let html = `<table class="table table-striped-columns sortable">`;
  html += `<thead><tr>
    <th>#</th>
    <th>Data</th>
    <th>Etapa</th>
    <th>T√≠tulo</th>
    <th>Status</th>
  </tr></thead><tbody>`;

  tarefasDoPeriodo.forEach((t, i) => {
    const dia = (`0${t.dia}`).slice(-2);
    const mesNum = (`0${t.mes}`).slice(-2);
    html += `<tr>
      <td>${i + 1}</td>
      <td>${dia}/${mesNum}/${t.ano}</td>
      <td><div class="badge badge-${t.tipo}">${t.tipo}</div></td>
      <td>${t.titulo}</td>
      <td>${t.status}</td>
    </tr>`;
  });

  html += "</tbody></table>";
  tabelaDiv.innerHTML = html;
}

function updateTotals(tarefasDoPeriodo) {
  const countsTipo = { texto: 0, layout: 0, html: 0 };
  const countsStatus = { pendente: 0, conclu√≠do: 0 };

  tarefasDoPeriodo.forEach(t => {
    if (countsTipo[t.tipo] !== undefined) countsTipo[t.tipo]++;
    if (countsStatus[t.status] !== undefined) countsStatus[t.status]++;
  });

  totaisDiv.innerHTML = `
    <span class="badge text-bg-secondary">Textos: ${countsTipo.texto}</span>
    <span class="badge text-bg-secondary">Layouts: ${countsTipo.layout}</span>
    <span class="badge text-bg-secondary">HTMLs: ${countsTipo.html}</span>
    <span class="badge text-bg-warning">‚è≥ Pendentes: ${countsStatus.pendente}</span>
    <span class="badge text-bg-success">‚úÖ Conclu√≠das: ${countsStatus.conclu√≠do}</span>
  `;
}

gerarBtn.addEventListener("click", async () => {
  const projeto = projetoSelect.value;
  const ano = parseInt(anoInput.value);
  const mes = parseInt(mesSelect.value);

  if (!projeto) {
    alert("Selecione um projeto.");
    return;
  }

  const dadosBrutos = await carregarDadosDoGitHub(projeto, ano, mes);
  tarefas = transformarTarefas(dadosBrutos);
  gerarCalendario();
  gerarTabela();
  updateTotals(tarefas);
});

// Regenerar ao mudar filtros
[filtroStatus, buscaTitulo, ocultarVazios].forEach(el => {
  el.addEventListener("input", () => {
    gerarCalendario();
    gerarTabela();
    updateTotals(tarefas);
  });
});

document.addEventListener("DOMContentLoaded", async () => {
  await carregarProjetos();

  const projetoInicial = projetoSelect.value;
  if (projetoInicial) {
    atualizarPeriodos(projetoInicial);
  }
});

projetoSelect.addEventListener("change", () => {
  const projeto = projetoSelect.value;
  if (projeto) {
    atualizarPeriodos(projeto);
  } else {
    anoInput.innerHTML = '<option value="">Ano</option>';
    mesSelect.innerHTML = '<option value="">M√™s</option>';
  }
});
</script>
</body>
</html>
